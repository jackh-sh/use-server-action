# Server Action

Server-side utilities for creating and handling server actions.

```ts
import {
    serverAction,
    success,
    error,
    HandledError,
    isSuccess,
    isError,
    unwrap,
    unwrapOr,
} from "use-server-action/server";
```

## serverAction

Wraps an async function to return a standardized `ServerActionResult`. Automatically catches errors and converts them to error results.

**Error handling behavior:**
- Returning `success(data)` or a plain value → `{ ok: true, data }`
- Returning `error(message, code)` → `{ ok: false, message, code }`
- Throwing a `HandledError` → `{ ok: false, message, code }` (message is surfaced to the client)
- Throwing any other error → `{ ok: false, message: "An unexpected error occurred", code: "UNKNOWN_ERROR" }` (original message is hidden)

This means unexpected errors (database failures, programming errors, etc.) are never accidentally exposed to the client.

```ts
import { serverAction, HandledError } from "use-server-action/server";

export const createUserAction = serverAction(async (name: string) => {
    // Throw HandledError to surface a specific message to the client
    if (!name.trim()) {
        throw new HandledError("Name is required", "VALIDATION_ERROR");
    }

    const user = await db.user.create({ data: { name } });
    return user; // Automatically wrapped in { ok: true, data: user }
});
```

### With Error Callback

```ts
export const createUserAction = serverAction(
    async (name: string) => {
        const user = await db.user.create({ data: { name } });
        return user;
    },
    {
        onError: (error) => {
            // Log errors to your error tracking service (called for all errors)
            console.error("Action failed:", error);
        },
    }
);
```

## HandledError

A special error class that allows you to throw an error inside a `serverAction` and have its message surfaced to the client. Plain `Error` throws result in a generic error message to avoid leaking internal details.

```ts
import { HandledError } from "use-server-action/server";

throw new HandledError(message: string, code?: string)
```

Use `HandledError` when you want to throw (rather than return) an error with a specific, user-facing message:

```ts
export const updateUserAction = serverAction(async (id: string, data: UpdateData) => {
    const user = await db.user.findUnique({ where: { id } });

    // Throw to exit early from any depth in the call stack
    if (!user) {
        throw new HandledError("User not found", "NOT_FOUND");
    }

    if (data.role === "admin" && !isAdmin()) {
        throw new HandledError("Insufficient permissions", "FORBIDDEN");
    }

    return await db.user.update({ where: { id }, data });
});
```

### HandledError vs return error()

Both produce the same result shape. Choose based on control flow:

```ts
// Use return error() when you want to return from the current function
if (!user) {
    return error("User not found", "NOT_FOUND");
}

// Use throw new HandledError() when you want to exit from a nested call
async function validateUser(id: string) {
    const user = await db.user.findUnique({ where: { id } });
    if (!user) {
        throw new HandledError("User not found", "NOT_FOUND");
    }
    return user;
}

export const action = serverAction(async (id: string) => {
    const user = await validateUser(id); // HandledError propagates up
    return user;
});
```

## success / error

Helper functions to manually create result objects:

```ts
import { success, error } from "use-server-action/server";

export async function updateUserAction(id: string, data: UpdateData) {
    const user = await db.user.findUnique({ where: { id } });

    if (!user) {
        return error("User not found", "NOT_FOUND");
    }

    if (user.email !== data.email) {
        const existing = await db.user.findUnique({
            where: { email: data.email }
        });
        if (existing) {
            return error("Email already in use", "DUPLICATE_EMAIL");
        }
    }

    const updated = await db.user.update({
        where: { id },
        data,
    });

    return success(updated);
}
```

### success(data)

Creates a successful result:

```ts
success({ id: "1", name: "John" })
// => { ok: true, data: { id: "1", name: "John" } }
```

### error(message, code?)

Creates an error result:

```ts
error("Not found", "NOT_FOUND")
// => { ok: false, message: "Not found", code: "NOT_FOUND" }

error("Something went wrong")
// => { ok: false, message: "Something went wrong" }
```

## Type Guards

### isSuccess / isError

Type guards for narrowing result types:

```ts
import { isSuccess, isError } from "use-server-action/server";

const result = await myAction(input);

if (isSuccess(result)) {
    // TypeScript knows result.data exists
    console.log(result.data);
}

if (isError(result)) {
    // TypeScript knows result.message exists
    console.log(result.message, result.code);
}
```

## Unwrap Utilities

### unwrap(result)

Extracts data from a successful result, or throws on error:

```ts
import { unwrap } from "use-server-action/server";

try {
    const user = unwrap(await createUser("John"));
    console.log(user); // The user data
} catch (e) {
    // Thrown if result was an error
    console.error(e.message);
}
```

### unwrapOr(result, defaultValue)

Extracts data from a successful result, or returns a default value:

```ts
import { unwrapOr } from "use-server-action/server";

const user = unwrapOr(await getUser(id), null);
// Returns the user if successful, or null if error

const count = unwrapOr(await getCount(), 0);
// Returns the count if successful, or 0 if error
```

## Combining Actions

You can call server actions from other server actions:

```ts
export const createUserWithProfile = serverAction(async (data: CreateUserData) => {
    // Create the user
    const userResult = await createUser(data.name);
    if (!userResult.ok) {
        return userResult; // Forward the error
    }

    // Create the profile
    const profileResult = await createProfile({
        userId: userResult.data.id,
        bio: data.bio,
    });
    if (!profileResult.ok) {
        // Rollback or handle error
        await deleteUser(userResult.data.id);
        return error("Failed to create profile", "PROFILE_ERROR");
    }

    return success({
        user: userResult.data,
        profile: profileResult.data,
    });
});
```
